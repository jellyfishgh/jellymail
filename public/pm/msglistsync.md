# 消息列表同步

## 一.需求

消息列表实现多端同步,最多50个.

## 二.实现规则

### 2.1.客户端

这个功能上线时:

1. 客户端确认某个未读对象为已读或者新创建一个会话时,把该对象的id发送给服务端,服务端放在 消息列表 中存储起来;
1. 客户端登录时向服务端发送时间来请求 消息列表 的增量数据;
1. 客户端把登录时服务端下发的 消息列表 , 未读条数生成的额外对象，本地消息对象 做一下更新合并操作并刷新消息界面;
1. 客户端在做更新合并操作时要剔除请求到的 消息列表 中的异常id 和 本地维护的已被移除过的对象id;
1. 左滑移除本地的消息对象时，本地移除并告知服务端已读, 并且本地维护已被移除过的对象列表；

### 2.2.服务端

#### 2.2.1.多端在线同步

现在好友,讨论组,群和帮派已做多端实时同步;

#### 2.2.2.离线下发

1. 原来的未读消息不再下发，只下发所有未读消息对象对应的未读消息条数和id;
1. 服务端给每个人维护一个消息列表，包含未读消息对象和已读消息对象，最多包含50项, 按照最近一条消息对应的时间排序；
1. 服务端收到客户端新增id的协议时,如果列表A中不包含该id就执行增加id操作;服务端收到客户端移除id的协议时，如果列表A中包含该id则执行移除id的操作；
1. 服务端收到客户端附带时间的请求时,下发列表A的增量数据,其中下发的每一项需要包含 id,最近一条消息内容和时间;
1. 对于解散群,退出群,被移除群,被移除帮派,退出讨论组,被移除讨论组,删好友,被删好友等操作时需要做删除操作来维护列表A;

## 三.待确认的问题

对于我已经不在的群,讨论组和帮派以及不是我的好友了的id列表该怎么维护?

目前想到以下三种方案:

* 在退群,退讨论组,解散群,删好友等操作时服务端去维护相关的列表A;
* 客户端在执行移除群成员等操作时告诉服务端去删除列表A中的相关id;
* 客户端在执行 2.1.-3. 中的更新合并操作时会剔除请求到的 `已读消息列表A1` 中的异常id,剔除完毕后告诉服务端也去移除列表A中的异常id;

> 确认使用 1

## 四.删除和置顶

### 4.1.删除

#### 4.1.1.删除已读

本地维护一个已被删除的列表，不跟服务端同步；服务端下发后不显示该列表中的消息对象；

#### 4.1.2.删除未读

删除时做消息已读的操作，不跟服务端同步；服务端下发后不显示该列表中的消息对象；

### 4.2.置顶

置顶或取消置顶时，客户端上操作完成后给服务端异步发一个通知；
没有收到服务端确认成功或超时，放在本地维护；
下次登录时继续向服务端发送同步的通知；