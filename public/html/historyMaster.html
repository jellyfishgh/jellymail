<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>战盟 app 更新记录</title>
    <style>
        html,
        body,
        div,
        ul,
        li,
        label {
            padding: 0;
            margin: 0;
        }
        
        ul,
        li {
            list-style: none;
        }
        
        .container {
            min-width: 200px;
            width: 80%;
            margin: 20px auto;
        }
        
        .divSection {
            margin: 20px auto;
        }
        
        .liItem {
            margin: 5px 30px;
        }
        
        .submitWebBtn {
            display: block;
            width: 60px;
            margin: 0 auto;
        }
        
        .msgForm input {
            display: block;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <label for="iosRadio">iOS</label><input type="radio" name="platform" value="iOS" id="iosRadio" checked="checked" />
    <label for="androidRadio">Android</label><input type="radio" name="platform" value="Android" id="androidRadio" />
    <input type="text" placeholder="请输入版本号" id="versionInput">
    <input type="text" placeholder="请输入日期：xxxx.xx.xx" id="dateInput">
    <div id="container" class="container"></div>
    <div id="imMsgForm" class="container">
        <form class="msgForm" id="msgForm">
            <input type="text" placeholder="请输入标题" size="100" name="title">
            <input type="text" placeholder="请输入摘要" size="100" name="desc">
        </form>
        <input type="submit" value="提交" class="submitWebBtn" id="msgSubmitBtn" />
    </div>
    <script>
        var container = $("container");

        $("msgSubmitBtn").onclick = function(e) {
            postData('/msg', new FormData($('msgForm')), function(resData) {
                alert(resData);
            }, function() {
                alert("提交失败");
            });
        };

        function createEle(name, attrObj) {
            var ele = document.createElement(name);
            for (var key in attrObj) {
                ele[key] = attrObj[key];
            };
            return ele;
        }

        function $(id) {
            return document.getElementById(id);
        }

        function getRadioValue() {
            var radios = document.getElementsByName("platform");
            for (i = 0; i < radios.length; i++) {
                if (radios[i].checked) {
                    return radios[i].value;
                }
            }
        }

        function createSection() {
            var divSection = createEle("div", {
                className: "divSection",
                id: "divSection"
            });

            var typeInput = createEle("input", {
                className: "typeInput",
                id: "typeInput",
                placeholder: "请输入记录类别",
                type: "text",
                size: "20"
            });
            divSection.appendChild(typeInput);

            var addSectionBtn = createEle("button", {
                className: "addSectionBtn",
                id: "addSectionBtn",
                innerHTML: "+"
            });
            addSectionBtn.onclick = function(e) {
                divSection.removeChild(e.target);
                addSection();
            };
            divSection.appendChild(addSectionBtn);

            var ulItems = createEle("ul", {
                className: "ulItems"
            });
            ulItems.appendChild(createItem(ulItems));
            divSection.appendChild(ulItems);

            return divSection;
        }

        function createItem(ulItems) {
            var liItem = createEle("li", {
                className: "liItem"
            });
            liItem.appendChild(createEle("input", {
                placeholder: "请输入该类别的记录项",
                size: "100"
            }));
            liItem.appendChild(createEle("button", {
                className: "addItemBtn",
                id: "addItemBtn",
                innerHTML: "+",
                onclick: function(e) {
                    liItem.removeChild(e.target);
                    ulItems.appendChild(createItem(ulItems));
                }
            }));
            return liItem;
        }

        function addSection() {
            container.insertBefore(createSection(), $("submitWebBtn"));
        }

        function submitWebHandler() {
            var api = '/history';
            var data = {
                'platform': getRadioValue()
            };
            var version = $("versionInput").value;
            if (version) {
                data.version = version;
            } else {
                alert("请输入版本号");
                return;
            }
            var date = $("dateInput").value;
            if (date) {
                data.date = date;
            } else {
                alert("请输入日期");
                return;
            }
            var contents = getContents();
            if (contents.length === 0) {
                alert("请输入内容");
                return;
            } else {
                data.contents = contents;
            }
            postData(api, JSON.stringify(data), function(resData) {
                alert(resData);
            }, function() {
                alert("提交失败");
            });
        }

        function getContents() {
            var contens = [];
            var nodes = container.childNodes;
            for (var i = 0; i < nodes.length - 1; i++) {
                var node = nodes[i];
                var type, content = {};
                if (i === nodes.length - 2) {
                    type = node.childNodes[1].value;
                    if (type) {
                        content.name = type;
                    }
                } else {
                    type = node.firstChild.value;
                    if (type) {
                        content.name = type;
                    }
                }
                if (type) content.items = getItems(node.lastChild.childNodes);
                contens.push(content);
            }
            return contens;
        }

        function getItems(lis) {
            var items = [];
            for (var i = 0; i < lis.length; i++) {
                var itemText = lis[i].lastChild.value;
                if (itemText) items.push(itemText);
            }
            return items;
        }

        function postData(api, data, resolve, reject, json) {
            var xhr = new XMLHttpRequest();
            xhr.open('POST', api);
            xhr.onreadystatechange = function() {
                if (this.readyState == 4) {
                    if (this.status == 200) {
                        resolve(this.response);
                    } else {
                        reject();
                    }
                }
            };
            if(json)xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.send(data);
        }

        var submitWebBtn = createEle("button", {
            id: "submitWebBtn",
            className: "submitWebBtn",
            innerHTML: "提交",
            onclick: submitWebHandler
        });
        container.appendChild(submitWebBtn);
        addSection();
    </script>
</body>

</html>